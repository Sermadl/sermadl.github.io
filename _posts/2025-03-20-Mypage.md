---
title: "MSA êµ¬í˜„í•˜ê¸°(7) - Aggregation ì ìš©í•´ì„œ ë§ˆì´í˜ì´ì§€ êµ¬ì„±í•˜ê¸° (feat. API Gateway)"
categories: [Spring Boot, MSA]
tags:
  [
    MSA,
    Spring,
    API Gateway,
    Aggregation,
    REST API,
    Spring Boot,
    Java,
    SKALA,
    SKALA1ê¸°,
    SK
  ]
---

> Skala ê³¼ì •ì—ì„œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ êµ¬ì¡°ì— ëŒ€í•´ ìƒˆë¡­ê²Œ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
> ë°°ìš´ ê²ƒì„ ì‹¤ì œë¡œ êµ¬í˜„í•´ë³´ê¸° ìœ„í•´ ì´ ì—¬ì •ì„ ì‹œì‘í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.<br>[ì²˜ìŒ ê¸€ë¶€í„° ë³´ëŸ¬ê°€ê¸°](<https://sermadl.github.io/posts/MSA(1)/>)

ì´ ê¸€ì„ ì“°ê¸°ê¹Œì§€ ì •ë§ì •ë§ ì˜¤ëœ ì‹œê°„ì´ ê±¸ë ¸ìŠµë‹ˆë‹¤....ã…œã…œ~~ì§„ì‘ REST APIë¡œ í•  ê±¸ ê´œíˆ GraphQL í•˜ê² ë‹¤ê³  ì„¤ì³ì„œëŠ”~~<br>

ë³¸ê²©ì ì¸ Aggregation ê¸°ëŠ¥ë“¤ì„ ì‚¬ìš©í•˜ê¸°ì— ì•ì„œ ê¸°ë³¸ì ìœ¼ë¡œ Gateway ì„œë²„ì—ì„œ ë™ê¸°, ë¹„ë™ê¸° ë°©ì‹ì„ ì´ìš©í•´ì„œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì™€ í†µì‹ í•˜ê³ , ë°˜í™˜ ë°›ì€ ê°’ì„ ìœµí•©í•´ì„œ ìƒˆë¡œìš´ í˜•íƒœë¡œ ë°˜í™˜í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤!<br>

## ë§ˆì´í˜ì´ì§€ ê¸°ëŠ¥

ì €ëŠ” ë§ˆì´í˜ì´ì§€ê°€ ê°€ì¥ Aggregationì„ ì ìš©í•´ë³´ê¸° ì¢‹ì€ ê¸°ëŠ¥ì´ë¼ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.<br>

ì´ì „ ê¸€ì˜ ê¸°ëŠ¥ëª…ì„¸ì„œì—ë„ ì‘ì„±ë˜ì–´ ìˆì§€ë§Œ,<br>
ë§ˆì´í˜ì´ì§€ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>

> 1. ìµœê·¼ ì£¼ë¬¸í•œ ìƒí’ˆ ë³´ê¸°
>
> - ë¡œê·¸ì¸ ëœ ìœ ì €ì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì£¼ë¬¸ ëª©ë¡ê³¼ ìƒí’ˆ ì •ë³´ë¥¼ ëª©ë¡ìœ¼ë¡œ ë³´ì—¬ì¤˜ì•¼í•¨
>
> 2. ì£¼ë¬¸ íšŸìˆ˜
>
> - ë¡œê·¸ì¸ ëœ ìœ ì €ì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì´ ì£¼ë¬¸ ëª©ë¡ì„ ê°€ì ¸ì™€ ê°œìˆ˜ë¥¼ ë³´ì—¬ì¤˜ì•¼í•¨
>
> 3. ë°°ì†¡ ì¤‘ì¸ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸í•˜ê¸°
>
> - ë¡œê·¸ì¸ ëœ ìœ ì €ì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•„ì§ â€˜ë°°ì†¡ì¤‘â€™ ìƒíƒœì¸ ì£¼ë¬¸ë‚´ì—­ì˜ ìƒí’ˆ ëª©ë¡ì„ ë³´ì—¬ì¤˜ì•¼í•¨
>
> ì¶”ê°€ì ìœ¼ë¡œ ì§€ê¸ˆê¹Œì§€ í• ì¸ë°›ì€ ì´ì•¡ê¹Œì§€ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤ëŠ” ìš•ì‹¬..ì´ ìˆìŠµë‹ˆë‹¤ ã…ã…

ìš°ì„  1ë²ˆ ê¸°ëŠ¥ë§Œ ì´ë²ˆ ê¸€ì—ì„œ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤!<br>

## ë¡œì§ êµ¬ìƒí•˜ê¸°

1.  ë¡œê·¸ì¸ ë˜ì–´ìˆëŠ” ì‚¬ìš©ìì˜ ì •ë³´ê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— User Serverì—ì„œ í† í° ê²€ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.<br>
2.  í† í° ê²€ì¦ ì´í›„ì— ë°˜í™˜ ë°›ì€ ì‚¬ìš©ì ì •ë³´ë¡œ Order Serverì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ ì£¼ë¬¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.<br>
3.  ì£¼ë¬¸ ëª©ë¡ì— ìˆëŠ” ìƒí’ˆ IDë¡œ Item Serverì—ì„œ ìƒí’ˆ ì •ë³´ë¥¼ ë°˜í™˜ ë°›ì•„ ë¦¬ìŠ¤íŠ¸ë¡œ ì €ì¥í•©ë‹ˆë‹¤.<br>

ë”°ë¼ì„œ Aggregationì´ í•„ìš”í•©ë‹ˆë‹¤!!!

## ì‹¤ì œ êµ¬í˜„í•˜ê¸°

### AggregationController.java

```java
@RestController
@Slf4j
@RequiredArgsConstructor
public class AggregationController {
    private final UserServiceClient userServiceClient;
    private final OrderServiceClient orderServiceClient;
    private final ItemServiceClient itemServiceClient;

    @GetMapping("/my-page")
    public Flux<ItemResponse> getMyPage(ServerWebExchange e) {

        // ì‚¬ìš©ì ì¸ì¦
        ValidTokenResponse response = userServiceClient.tokenValidation(e);

        log.info("User Info: {}", response.getId());
        log.info("{}", response.getRole());
        log.info("{}", response.getUsername());

        // ë¡œê·¸ì¸ ëœ ì‚¬ìš©ìì˜ ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
        Flux<OrderResponse> orderResponses = orderServiceClient.getPurchaseList(response.getId());

        // ì£¼ë¬¸ ëª©ë¡ì—ì„œ ìƒí’ˆ IDë§Œ ì¶”ì¶œ í›„, ìƒí’ˆ ì •ë³´ ì¡°íšŒ
        return orderResponses
                .flatMap(order -> Flux.fromIterable(order.getOrderItemResponses()))
                .map(OrderItemResponse::getItemId)
                .distinct() // ì¤‘ë³µëœ ì•„ì´í…œ ì œê±°
                .flatMap(itemServiceClient::getItem); // ê° ì•„ì´í…œ ì •ë³´ ì¡°íšŒ
    }
}
```

`ServerWebExhange` ë¡œ Headerì— í¬í•¨ë˜ì–´ ìˆëŠ” JWT í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.<br>

í† í°ì´ ìœ íš¨í•œì§€ ê²€ì‚¬í•˜ê³ , ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë°›ì•„ì˜¤ë©´ ì´ ì‚¬ìš©ìì˜ ì£¼ë¬¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>

`return` ë¶€ë¶„ì´ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.<br>

ë¶ˆëŸ¬ì˜¨ ì£¼ë¬¸ ëª©ë¡ì´ `Mono` ì´ê¸° ë•Œë¬¸ì— `stream()`ì´ë‚˜ `forEach()` ë¡œëŠ” ë¦¬ìŠ¤íŠ¸ì˜ ìš”ì†Œë¥¼ ìˆœí™˜í•  ìˆ˜ ì—†ì–´ì„œ `.flatMapMany(Flux::_fromIterable_)` ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>

ì´í›„ ê° ì£¼ë¬¸ ë‚´ì—­ì—ì„œ ìƒí’ˆ ì •ë³´ë§Œ ê°€ì ¸ì˜¤ê³ , ì—¬ê¸°ì„œ ìƒí’ˆì˜ IDë§Œ ì¶”ì¶œí•œ ì´í›„ì— ì¤‘ë³µëœ ê°’ì„ ì œê±°í•©ë‹ˆë‹¤.<br>

ì´ë ‡ê²Œ ê°€ì ¸ì˜¨ ìƒí’ˆ Idë¡œ ê°ê° ìƒí’ˆ ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ ë°›ì€ ë°˜í™˜ê°’ì„ Listì˜ í˜•íƒœë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.<br>

> `HttpServletRequest` ë„ Header ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìˆëŠ” ê²ƒìœ¼ë¡œ ì•Œê³  ìˆì—ˆëŠ”ë°, ì—¬ê¸°ì„œëŠ” ì™œ ì‚¬ìš©í•˜ì§€ ì•Šëƒê³  GPTì—ê²Œ ë¬¼ì–´ë³´ë‹ˆ..<br>
>
> Q: ServerWebExchangeë§ê³  HttpServletRequestë¥¼ ì“°ë©´ í—¤ë” ì¶”ì¶œì„ ëª»í•´?<br>
>
> A: ë„¤, `Spring WebFlux` ì—ì„œëŠ” HttpServletRequestë¥¼ **ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.<br>
> ì´ìœ ëŠ” WebFluxê°€ ë¹„ë™ê¸° ë…¼ë¸”ë¡œí‚¹(Non-blocking) í™˜ê²½ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©°, **ì„œë¸”ë¦¿ ê¸°ë°˜ì˜ HttpServletRequestëŠ” ë¸”ë¡œí‚¹ ë°©ì‹**ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
>
> í˜„ì¬ ì„œë²„ê°€ WebFlux(ë¹„ë™ê¸°) ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤!
>
> _ì €ì™€ ê°™ì€ ì˜ë¬¸ì„ ê°€ì§€ì‹  ë¶„ì—ê²Œ ë„ì›€ì´ ë˜ê¸¸ ë°”ëë‹ˆë‹¤,,ã…ã…_

<hr>

### UserServiceClient.java

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class UserServiceClient {
    private final WebClient.Builder webClientBuilder;

    ...

    public ValidTokenResponse tokenValidation(ServerWebExchange exchange) {
        String header = exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);

        log.info("Header: {}", header);

        if (header == null || !header.startsWith("Bearer ")) {
            throw new InvalidTokenException();
        }

        return webClientBuilder.build()
                .get()
                .uri("http://USER-SERVICE/validation")
                .header(HttpHeaders.AUTHORIZATION, header)
                .retrieve()
                .onStatus(HttpStatusCode::is4xxClientError, clientResponse -> {
                    throw new InvalidTokenException();
                })
                .bodyToMono(ValidTokenResponse.class)
                .block();
    }
}
```

ìš”ê¸°ì„œëŠ” Headerì—ì„œ ì •ìƒì ì¸ Bearer Tokenì„ ë³´ëƒˆì„ ë•Œì™€ ê·¸ë ‡ì§€ ì•Šì•˜ì„ ë•Œë¥¼ ëŒ€ë¹„í•´ì„œ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í•´ì¤¬ìŠµë‹ˆë‹¤.<br>

`WebClient` ë¥¼ ì‹¤í–‰í•˜ë˜ ì¤‘ì— ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ, `onStatus` ë¥¼ í™œìš©í•´ì„œ ìƒíƒœ ì½”ë“œ ë³„ë¡œ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í•´ì¤„ ìˆ˜ë„ ìˆê³ , `doOnError` ë¥¼ í†µí•´ ì–´ë–¤ ì—ëŸ¬ë“  ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>

`throw new InvalidTokenException()` ë¶€ë¶„ì€ ì œê°€ ì»¤ìŠ¤í…€ ì—ëŸ¬ë¥¼ ì ìš©í•œ ë¶€ë¶„ì´ë¼,<br>
`RuntimeException()` ì´ë‚˜ `IllegalArgumentException()` ì„ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤<br>

> ì¶”í›„ì— ì»¤ìŠ¤í…€ ì—ëŸ¬ì— ëŒ€í•œ ë¶€ë¶„ì„ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤<br>

<hr>

### OrderServiceClient.java

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class OrderServiceClient {

    private final WebClient.Builder webClientBuilder;

    ...

    public Flux<OrderResponse> getPurchaseList(Long customerId) {
        return webClientBuilder.build()
                .get()
                .uri("http://ORDER-SERVICE/list/{customerId}", customerId)
                .retrieve()
                .bodyToFlux(OrderResponse.class);
    }
}
```

ì´ ì½”ë“œë¥¼ êµ¬í˜„í•˜ë©´ì„œ `Flux` ì™€ `Mono<List>` ì˜ ì°¨ì´ì ì— ëŒ€í•´ì„œë„ ê¶ê¸ˆí•´ì„œ GPTì—ê²Œ ë¬¼ì–´ë´¤ìŠµë‹ˆë‹¤.<br><br>

> Q. Fluxì™€ Mono<List> ì˜ ì°¨ì´ì ì´ ë­ì•¼?
>
> A.
>
> ğŸš€ ê²°ë¡ 
>
> - Flux<T> â†’ ë°ì´í„°ê°€ ë§ê³  ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•  ë•Œ ì‚¬ìš©
> - Mono<List<T>> â†’ ëª¨ë“  ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜í•  ë•Œ ì‚¬ìš©
>
> ğŸ“Œ ì •ë¦¬í•˜ë©´?
>
> "í•œ ê°œì”© ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¬ë°" â Flux<T>
> "í•œêº¼ë²ˆì— ëª¨ì•„ì„œ ë°˜í™˜" â Mono<List<T>>
> ì–´ë–¤ ìƒí™©ì—ì„œ ì‚¬ìš©í• ì§€ ê³ ë¯¼ëœë‹¤ë©´ ë°ì´í„° ì–‘ê³¼ ë¹„ë™ê¸° ì²˜ë¦¬ê°€ í•„ìš”í•œì§€ë¥¼ ê³ ë ¤í•´ì„œ ì„ íƒí•˜ë©´ ë©ë‹ˆë‹¤! ğŸš€

ì €ëŠ” ì´ì™• `WebFlux` ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê¹€ì—, ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤ ã…ã…<br>

ë­”ê°€ ë¬¸ì œê°€ ìˆë‹¤ë©´ ë‚˜ì¤‘ì— í•´ê²°í•´ë³´ê² ìŠµë‹ˆë‹¤!<br>

<hr>

### ItemServiceClient.java

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class ItemServiceClient {

    private final WebClient.Builder webClientBuilder;

    ...

    public Mono<ItemResponse> getItem(Long itemId) {
        return webClientBuilder.build()
                .get()
                .uri("http://ITEM-SERVICE/{itemId}", itemId)
                .retrieve()
                .bodyToMono(ItemResponse.class);
    }
}
```

.<br>.<br>.<br><br>

### ê·¸ëŸ¬ë©´, êµ¬í˜„ ì™„ë£Œì…ë‹ˆë‹¤ (!!!!!)<br>

<hr>

### ì‹¤í–‰ ê²°ê³¼

![MyPage-Result](/assets/img/mypage-result.png)
![MyPage-Result](/assets/img/mypage-log.png)

ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>

## ë§ˆì¹˜ë©°

REST APIë„ GraphQL ëª»ì§€ì•Šê²Œ í¸í•©ë‹ˆë‹¤. (ã… ã… )<br>

ë‹¤ìŒì€ ì»¤ìŠ¤í…€ ì—ëŸ¬ ì½”ë“œ ì²˜ë¦¬ì— ëŒ€í•´ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤!<br>

ğŸ‘©ğŸ»â€ğŸ’»âœ¨

<hr>
<br>

> ì°¸ê³  ìë£Œ

[í•˜ë‚˜](https://velog.io/@jungse97/Spring-Cloud-API-Gateway-Filter), [ë‘˜](https://pixx.tistory.com/287), [ì…‹](https://velog.io/@jungse97/), [ë„·](Spring-Cloud-Users-Microservice-%EC%9D%B8%EC%A6%9D%EA%B3%BC-%EA%B6%8C%ED%95%9C), [ë‹¤ì„¯](https://medium.com/@premchandu.in/spring-webflux-aggregation-of-responses-from-different-microservices-acfb0e5f1fc5), [ì—¬ì„¯](https://docs.spring.io/spring-framework/reference/web/webflux-webclient/client-retrieve.html), [ì¼ê³±](https://engineering-skcc.github.io/developer/Developer-4/)
