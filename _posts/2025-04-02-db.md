---
title: "MSA êµ¬í˜„í•˜ê¸°(13) - ìƒí’ˆ ì¹´í…Œê³ ë¦¬ ê¸°ëŠ¥ ì¶”ê°€ (feat. SQL)"
categories: [Spring Boot, MSA]
tags: [MSA, Spring, R2DBC, MariaDB, SQL, Spring Boot, Java, SKALA, SKALA1ê¸°, SK]
---

> Skala ê³¼ì •ì—ì„œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ êµ¬ì¡°ì— ëŒ€í•´ ìƒˆë¡­ê²Œ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
> ë°°ìš´ ê²ƒì„ ì‹¤ì œë¡œ êµ¬í˜„í•´ë³´ê¸° ìœ„í•´ ì´ ì—¬ì •ì„ ì‹œì‘í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.<br>[ì²˜ìŒ ê¸€ë¶€í„° ë³´ëŸ¬ê°€ê¸°](<https://sermadl.github.io/posts/MSA(1)/>)

DB ì‹œê°„ì— ì˜¨ë¼ì¸ ì‡¼í•‘ëª°ì„ ì˜ˆì‹œë¡œ ERD ë° í…Œì´ë¸”ì„ ìƒì„±í•´ë³´ëŠ” ì‹¤ìŠµ ì‹œê°„ì´ ìˆì—ˆëŠ”ë°<br>
ì œ í”„ë¡œì íŠ¸ì—ë„ ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒ ê°™ì•„ì„œ í•´ë³´ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤!<br>

<hr>

## SQLë¡œ ì§ì ‘ í…Œì´ë¸” ì¶”ê°€í•˜ê¸°

R2DBCë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— Springì—ì„œ ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤ê³  í•´ë„<br>
ìë™ìœ¼ë¡œ í…Œì´ë¸”ì„ ìƒì„±í•´ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤!<br>
_ì‚¬ì‹¤ ê·¸ë˜ì„œ í•´ë´ì•¼ê² ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤ ã…ã…_<br>

### item í…Œì´ë¸”ì— category_id ì—´ ì¶”ê°€

```sql
ALTER TABLE category
CHANGE COLUMN sub_category_id parent_id INT;
```

ìš°ì„  `item` í…Œì´ë¸”ì— `category_id` ì—´ì„ ìƒˆë¡œ ì¶”ê°€í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.

<hr>

### category í…Œì´ë¸” ìƒì„±

```sql
CREATE TABLE `category` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(20) NOT NULL,
  `parent_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `FK_category` (`parent_id`),
  CONSTRAINT `FK_category` FOREIGN KEY (`parent_id`) REFERENCES `category` (`id`)
)
```

`category` í…Œì´ë¸”ì€ ì…€í”„ ì¡°ì¸ì„ í†µí•´ ê³„ì†í•´ì„œ ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.<br>

![category-table](/assets/img/category-table.png)

DBeaverë¡œ í™•ì¸í•´ë³´ë©´ ì´ë ‡ê²Œ ì…€í”„ ì¡°ì¸ì„ í•˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!<br>

<hr>

### category ë‚´ ë°ì´í„° ì‚½ì…

```sql
INSERT INTO `category` (name, parent_id)
VALUES ('FOOD', null);
.
.
.
INSERT INTO `category` (name, parent_id)
VALUES ('FROZEN FOOD', 1);
```

`INSERT` ë¥¼ í†µí•´ `category` ì•ˆì— ìƒ˜í”Œ ë°ì´í„°ë¥¼ ëª‡ ê°œ ë„£ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>

> idê°€ ìë™ìœ¼ë¡œ ì¦ê°€ë˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— í–‰ì„ ì‚½ì…í•  ë•Œ idë¥¼ ëª…ì‹œí•´ì£¼ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ 1ì”© ì¦ê°€ë˜ë©° ì‚½ì…ë©ë‹ˆë‹¤.<br>

![category-rows](/assets/img/category-rows.png)

<hr>

### itemì˜ category_idì— ê°’ ë„£ì–´ì£¼ê¸°

```sql
UPDATE item SET category_id = 10 WHERE id = 1;
```

ì„ì‹œë¡œ ìƒì„±í•´ë†“ì•˜ë˜ ìƒí’ˆë“¤ ì¤‘ í•˜ë‚˜ì— ê°’ì„ ë„£ì–´ë´¤ìŠµë‹ˆë‹¤!<br>

![item-category](/assets/img/item-category.png)

ì˜ ì‚½ì…ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ â˜ºï¸<br>

<hr>

## Spring ì½”ë“œë¡œ í…Œì´ë¸” ì—°ê²°í•˜ê¸°

R2DBC ê¸°ë°˜ìœ¼ë¡œ ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì˜ ì—°ê²°ì´ ë  ì§€ ë¶ˆì•ˆí–ˆì§€ë§Œ..<br>
ìƒê°ë³´ë‹¤ êµ‰ì¥íˆ ìˆ˜ì›”í•˜ê²Œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!<br>

### Category.java

```java
@Table
@Getter
@AllArgsConstructor
@NoArgsConstructor
public class Category {
    @Id
    private Long id;
    private String name;
    private Long parentId;

    public Category(String name) {
        this.name = name;
        this.parentId = null;
    }

    public Category(String name, Long parentId) {
        this.name = name;
        this.parentId = parentId;
    }
}
```

ëŒ€ë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ì˜ ê²½ìš° parentIdê°€ ì—†ì´ ì¶”ê°€ë˜ë‹ˆ, ìƒì„±ìë„ ì—¬ëŸ¬ê°œ ë§Œë“¤ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤!<br>

> `@Table` ê³¼ `@Id` ëª¨ë‘ `org.springframework.data` ì—ì„œ import ë˜ë„ë¡ í•´ì£¼ì„¸ìš”<br>

<hr>

### CategoryRepository.java

```java
public interface CategoryRepository extends R2dbcRepository<Category, Long> {
    Flux<Category> findByParentIdIsNull();
    Flux<Category> findByParentId(Long parentId);
}
```

ëŒ€ë¶„ë¥˜ë§Œ ì°¾ê¸° ìœ„í•´ `findByParentIdIsNull()` í•¨ìˆ˜ë¥¼ ì„ ì–¸í•˜ê³ <br>
ëŒ€ë¶„ë¥˜ ë° ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ì— ëŒ€í•´ ê¹Šì´ê°€ 1ì¸ ì¹´í…Œê³ ë¦¬ ëª©ë¡ë“¤ë§Œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆê²Œ `findByParentId()` í•¨ìˆ˜ë¥¼ ì„ ì–¸í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>

<hr>

### CategoryService.java

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class CategoryService {
private final CategoryRepository categoryRepository;

    public Flux<AllCategoryResponse> allCategories() {
        return categoryRepository.findByParentIdIsNull()
                .flatMap(this::getAllCategory);
    }

    public Mono<CategoryDetailsResponse> getCategoryDetails(Long id) {
        return categoryRepository.findByParentId(id)
                .map(Category::getName)
                .collectList()
                .map(CategoryDetailsResponse::new);
    }

    public Mono<Void> register(
            CategoryRegisterRequest request,
            Long userId,
            UserRole role
    ) {
        log.info("user({}) registering new category: {}", userId, request.getName());

        RoleCheck.isAdmin(role);

        Mono<Category> categoryMono;

        if (request.getParentId() == null) {
            categoryMono = Mono.just(new Category(request.getName()));
        } else {
            categoryMono = categoryRepository.findById(request.getParentId())
                    .switchIfEmpty(Mono.error(new CategoryNotFoundException()))
                    .map(parent -> new Category(request.getName(), parent.getId()));
        }

        return categoryMono
                .flatMap(categoryRepository::save)
                .switchIfEmpty(Mono.error(new CategoryRegisterException()))
                .then();
    }

    private Mono<AllCategoryResponse> getAllCategory(Category category) {
        return categoryRepository.findByParentId(category.getId())
                .map(Category::getName)
                .collectList()
                .map(children -> new AllCategoryResponse(category.getName(), children));
    }

}

```

ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ëŠ” ìœ„ì™€ ê°™ì´ ì‘ì„±í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>
ì„¸ë¶€ ë¡œì§ì€ ê°ì ìƒí™©ì— ë§ê²Œ êµ¬ì„±í•˜ë©´ ë˜ê³ , WebFlux í™˜ê²½ì—ì„œ ì›í™œí•˜ê²Œ ë™ì‘í•  ìˆ˜ ìˆë„ë¡ Monoë‚˜ Fluxë¥¼ ë°˜í™˜í•˜ë„ë¡ ë§Œë“¤ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤!<br>

<hr>

### CategoryController.java

```java
@RestController
@RequestMapping("/category")
@Slf4j
@RequiredArgsConstructor
public class CategoryController {
    private final CategoryService categoryService;

    /** [ê¶Œí•œ ì œí•œ ì—†ìŒ]
     * ì „ì²´ ì¹´í…Œê³ ë¦¬ ì¡°íšŒ
     * @return ì „ì²´ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë° ê¹Šì´ 1 ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ëª©ë¡
     */
    @GetMapping
    public Flux<AllCategoryResponse> allLargeCategories() {
        return categoryService.allCategories();
    }

    /** [ê¶Œí•œ ì œí•œ ì—†ìŒ]
     * ê°œë³„ ì¹´í…Œê³ ë¦¬ ë³„ ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ì¡°íšŒ
     * @param id ê°œë³„ ì¹´í…Œê³ ë¦¬ Id
     * @return ê°œë³„ ì¹´í…Œê³ ë¦¬ ë³„ ê¹Šì´ 1 ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ëª©ë¡
     */
    @GetMapping("/{categoryId}")
    public Mono<CategoryDetailsResponse> categoryDetails(
            @PathVariable("categoryId") Long id
    ) {
        return categoryService.getCategoryDetails(id);
    }

    /** [ê´€ë¦¬ì]
     * ì¹´í…Œê³ ë¦¬ ë“±ë¡(ì¶”ê°€)
     * @param request ì¹´í…Œê³ ë¦¬ ë“±ë¡ Request
     * @param userId ë¡œê·¸ì¸ ëœ ì‚¬ìš©ì User Id
     * @param role ë¡œê·¸ì¸ ëœ ì‚¬ìš©ì Role
     * @return Void
     */
    @PostMapping("/register")
    public Mono<Void> registerCategory(
            @RequestBody CategoryRegisterRequest request,
            @RequestHeader("x-user-id") Long userId,
            @RequestHeader("x-user-role") UserRole role
    ) {
        return categoryService.register(request, userId, role);
    }

}
```

ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ë„ ìœ„ì™€ ê°™ì´ ì‘ì„±í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>

<hr>

## ë§ˆì¹˜ë©°

### ê²°ê³¼ í™”ë©´

ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ ì¡°íšŒí•˜ë©´
![all-category](/assets/img/all-category.png)

<hr>

ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ë¥¼ ì¡°íšŒí•˜ë©´
![category-details](/assets/img/category-details.png)

<hr>

ì»¤ìŠ¤í…€ ì—ëŸ¬ë„ ì˜ ë™ì‘í•©ë‹ˆë‹¤!
![custom-error-code](/assets/img/custom-error.png)

<hr>

ì´ì œ ë°±ì—”ë“œ ë¶€ë¶„ì€ ë²„ê·¸ê°€ ìˆì§€ ì•ŠëŠ” ì´ìƒ ë” ê±´ë“œë¦¬ì§€ ì•Šê³ , ìˆ˜ì—… ì‹œê°„ì— ë°°ìš´ í”„ë¡ íŠ¸ë‚˜ AI ë¶€ë¶„ì„ ì ìš©ì‹œì¼œë³´ê³ ì í•©ë‹ˆë‹¤.<br>

ë‚˜ì¤‘ì— ë‹¤ì‹œ ë³´ì ìŠ¤í”„ë§ì•„,,,<br>

ë‹¤ìŒ ê¸€ë¶€í„°ëŠ” í™”ë©´ êµ¬ì„±ì— ëŒ€í•´ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤!<br>

ğŸ‘»ğŸ›’

<hr>
<br>

> ì°¸ê³  ìë£Œ

Skala êµìœ¡ ìë£Œ!
