---
title: "MSA êµ¬í˜„í•˜ê¸°(4) - DB êµ¬ì„± (feat. Docker)"
categories: [Spring Boot, MSA]
tags: [MSA, Docker, DB, Spring Boot, Java, SKALA, SKALA1ê¸°, SK]
---

> Skala ê³¼ì •ì—ì„œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ êµ¬ì¡°ì— ëŒ€í•´ ìƒˆë¡­ê²Œ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
> ë°°ìš´ ê²ƒì„ ì‹¤ì œë¡œ êµ¬í˜„í•´ë³´ê¸° ìœ„í•´ ì´ ì—¬ì •ì„ ì‹œì‘í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.<br>[ì²˜ìŒ ê¸€ë¶€í„° ë³´ëŸ¬ê°€ê¸°](<https://sermadl.github.io/posts/MSA(1)/>)

Dockerë¥¼ ì´ìš©í•˜ì—¬ MariaDB ì„œë²„ë¥¼ 3ê°œ ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤!

## MariaDB ì„œë²„ ë„ìš°ê¸°

### docker-compose.yml êµ¬ì„±

ì—¬ëŸ¬ ê°œì˜ MariaDB ì„œë²„ë¥¼ ë„ì›Œì•¼ í•˜ê¸° ë•Œë¬¸ì— docker-compose.yml íŒŒì¼ì„ ì´ìš©í•´ì„œ í•œêº¼ë²ˆì— ë„ì›Œë³´ê² ìŠµë‹ˆë‹¤.

```yml
version: "3.8"

services:
  order-db:
    image: mariadb:latest
    container_name: order-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
      MYSQL_DATABASE: order
      MYSQL_USER: ${USER}
      MYSQL_PASSWORD: ${PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - order_data:/var/lib/mysql
      - ./order-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mariadb_network
    healthcheck:
      test: ["CMD", "mariadb", "-uroot", "-p${ROOT_PASSWORD}", "-e", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  item-db:
    image: mariadb:latest
    container_name: item-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
      MYSQL_DATABASE: item
      MYSQL_USER: ${USER}
      MYSQL_PASSWORD: ${PASSWORD}
    ports:
      - "3309:3306"
    volumes:
      - item_data:/var/lib/mysql
      - ./item-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mariadb_network
    healthcheck:
      test: ["CMD", "mariadb", "-uroot", "-p${ROOT_PASSWORD}", "-e", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  user-db:
    image: mariadb:latest
    container_name: user-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
      MYSQL_DATABASE: user
      MYSQL_USER: ${USER}
      MYSQL_PASSWORD: ${PASSWORD}
    ports:
      - "3308:3306"
    volumes:
      - user_data:/var/lib/mysql
      - ./user-init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mariadb_network
    depends_on:
      order-db:
        condition: service_healthy
      item-db:
        condition: service_healthy

volumes:
  user_data:
  order_data:
  item_data:

networks:
  mariadb_network:
    driver: bridge
```

docker-compose.yml íŒŒì¼ì„ Gitì— ì˜¬ë¦´ ì˜ˆì •ì´ì–´ì„œ ë”°ë¡œ `.env` íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ ë³€ìˆ˜ë“¤ì˜ ë³´ì•ˆì„ ê´€ë¦¬í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>
.env íŒŒì¼ì€ docker-compose.ymlê³¼ ê°™ì€ ê²½ë¡œì— ì €ì¥í•˜ë©´ ë©ë‹ˆë‹¤.<br>

ê° ì„œë²„ì˜ í¬íŠ¸ë²ˆí˜¸ë„ ê²¹ì¹˜ì§€ ì•Šê²Œ ì„¤ì •í•©ë‹ˆë‹¤.<br>
ë„ì»¤ ì»¨í…Œì´ë„ˆë¡œ ì˜¬ë¦¬ì§€ ì•Šì€ ë¡œì»¬ mysqlê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ 3306 í¬íŠ¸ëŠ” í”¼í•´ì„œ ì„¤ì •í•´ì£¼ì—ˆìŠµë‹ˆë‹¤<br>

> ì‚¬ì‹¤ ë¡œì»¬ì— MySQL ê³¼ MariaDBë¥¼ ê°™ì´ ì„¤ì¹˜í•˜ë‹ˆ ì¶©ëŒì´ ì¼ì–´ë‚˜ì„œ Dockerë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤..

`user-db` ëŠ” `order-db` ì™€ `item-db` ê°€ ìƒì„±ëœ ì´í›„ì— federated ì—”ì§„ì„ í†µí•´ í…Œì´ë¸”ì„ ìƒì„±í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— `healthcheck` ë¥¼ ìˆ˜í–‰í•˜ì—¬ ë‘ ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ëœ ì´í›„ì— ìƒì„±ë˜ë„ë¡ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤<br>

<hr>

### .env íŒŒì¼

```properties
ROOT_PASSWORD={ë¹„ë°€ë²ˆí˜¸}
USER={ìœ ì € ì´ë¦„}
PASSWORD={ë¹„ë°€ë²ˆí˜¸}
USER_DATABASE=user
ITEM_DATABASE=item
ORDER_DATABASE=orders
ORDER_TABLE=orders
ITEM_DATABASE=item
ITEM_TABLE=item
```

<hr>

### ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± ë° ìœ ì € ìƒì„±/ê¶Œí•œ ë¶€ì—¬ ìë™í™”

ë§¤ë²ˆ `docker-compose up -d` ì„ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§Œë“¤ê³ , ìœ ì €ë¥¼ ìƒì„±í•˜ëŠ” ì¼ì€ êµ‰ì¥íˆ ê·€ì°®ìŠµë‹ˆë‹¤. <br>
ì›ë˜ ëª¨ë†€ë¦¬ì‹ êµ¬ì¡°ë¡œ ë™ì‘í•  ë•Œ ìœ ì €ì™€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” íŒŒì¼ì„ ë§Œë“¤ ë•Œì—ëŠ” init.sql íŒŒì¼ í•˜ë‚˜ë©´ ë˜ì§€ë§Œ ì €ëŠ” MSA êµ¬ì¡°ë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ë§Œë“¤ì–´ì•¼ í•  íŒŒì¼ì´ ë§ìŠµë‹ˆë‹¤.<br>
ê·¸ë˜ì„œ ì„œë²„ ë³„ë¡œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì§ˆ ìˆ˜ ìˆê²Œ `.sh` íŒŒì¼ì„ ë¨¼ì € ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.<br>

<hr>

#### entrypoint.sh

```shell
#!/bin/sh
export $(grep -v '^#' .env | xargs)
for file in user-init-template.sql item-init-template.sql order-init-template.sql; do
  envsubst < "$file" > "${file/-template/}"
done
```

ì´ë ‡ê²Œí•˜ë©´ user-init-templete.sql, item-init-template.sql, order-init-template.sqlì„ í•œë²ˆì— ê°ê°ì˜ init.sql íŒŒì¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>

`export ~` êµ¬ë¬¸ì„ ì‹¤í–‰í•˜ëŠ” ì´ìœ ëŠ” `.env` íŒŒì¼ì— ì €ì¥ë˜ì–´ ìˆëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ì•ˆì „í•˜ê²Œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ìœ ì €ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.<br>
ë˜í•œ, í•œêº¼ë²ˆì— ë³€ìˆ˜ë“¤ì„ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ ìœ ì§€ë³´ìˆ˜ë„ í¸ë¦¬í•©ë‹ˆë‹¤.

<hr>

#### init.sql íŒŒì¼ (Ex: user-init-template.sql)

```sql
CREATE DATABASE IF NOT EXISTS `${USER_DATABASE}`;
USE `${USER_DATABASE}`;

CREATE TABLE IF NOT EXISTS `${USER_TABLE}` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT,
    `email` varchar(255) DEFAULT NULL,
    `password` varchar(255) DEFAULT NULL,
    `phone` varchar(255) DEFAULT NULL,
    `username` varchar(255) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci;

CREATE TABLE IF NOT EXISTS federated_item (
    id BIGINT(20) NOT NULL AUTO_INCREMENT,
    quantity INT(11) NOT NULL,
    seller_id BIGINT(20) DEFAULT NULL,
    description VARCHAR(255) DEFAULT NULL,
    name VARCHAR(255) DEFAULT NULL,
    PRIMARY KEY (id)
) ENGINE=FEDERATED
CONNECTION='mysql://${USER}:${PASSWORD}@host.docker.internal:3309/item/item';

CREATE TABLE IF NOT EXISTS federated_orders (
    id BIGINT(20) NOT NULL AUTO_INCREMENT,
    address VARCHAR(255) DEFAULT NULL,
    customer_id BIGINT(20) DEFAULT NULL,
    description VARCHAR(255) DEFAULT NULL,
    item_id BIGINT(20) DEFAULT NULL,
    order_date DATETIME(6) DEFAULT NULL,
    quantity INT(11) NOT NULL,
    PRIMARY KEY (id)
) ENGINE=FEDERATED
CONNECTION='mysql://${USER}:${PASSWORD}@host.docker.internal:3307/orders/orders';

CREATE USER IF NOT EXISTS '${USER}'@'%' IDENTIFIED BY '${PASSWORD}';
GRANT ALL PRIVILEGES ON `${USER_DATABASE}`.* TO '${USER}'@'%';
FLUSH PRIVILEGES;
```

ì´ëŸ° ì‹ìœ¼ë¡œ ëª¨ë“  íŒŒì¼ì„ ì‘ì„±í•´ì£¼ë©´ `docker-compose up -d` ë§Œ ì‹¤í–‰í•´ì£¼ë©´ MariaDB ì„œë²„ 3ê°œê°€ ë™ì‹œì— ìƒê¸°ê²Œ ë©ë‹ˆë‹¤.<br>

ìœ„ sqlë¬¸ì˜ ë‹¨ì ì´ í•œ ê°€ì§€ ìˆëŠ”ë°,<br>
ìŠ¤í”„ë§ì—ì„œ ì—”í‹°í‹°ì˜ êµ¬ì¡°ê°€ ë°”ë€” ë•Œë§ˆë‹¤ DDLì„ ë³€ê²½í•´ì£¼ì–´ì•¼ í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤,,,<br>

~~###### ë” ì¢‹ì€ ë°©ë²•ì´ ìˆë‹¤ë©´ ì•Œë ¤ì£¼ì„¸ìš¥,,<br>ë‹¤ë¥¸ ì¢‹ì€ ë°©ë²•ì´ ìƒê¸°ë©´ ìˆ˜ì •í•´ë³´ê² ìŠµë‹ˆë‹¤!~~
> 2025.03.14<br>ì°¾ì•˜ìŠµë‹ˆë‹¤! [ìš”ê¸°](https://sermadl.github.io/posts/Aggregation/)ë¡œ ì˜¤ì„¸ìš§<br>Federated ê´€ë ¨ ì„¤ì •ì„ ì•„ì˜ˆ ì—†ì• ë„ ì¢‹ìŠµë‹ˆë‹¤ *^^* <br>(ì¦‰, init.sqlì˜ í…Œì´ë¸” ì„ ì–¸ ì½”ë“œ ë¶€ë¶„ì´ ì—†ì–´ë„ ëœë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤ í•˜í•˜)

ê·¸ë˜ë„ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•  ë•Œë§ˆë‹¤ ê³„ì†í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê³ , ìœ ì €ë¥¼ ë§Œë“¤ì–´ì„œ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ì¼ë ¨ì˜ ê³¼ì •ë“¤ì´ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤!<br>

<hr>

#### `FEDERATED` ì—”ì§„

> MariaDB ì— ìˆëŠ” FEDERATED ì—”ì§„ì„ ì‚¬ìš©í•˜ë©´ Oracleì˜ `SYNONYM`ì„ ì´ìš©í•œ DB Link ê°™ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì™¸ë¶€ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆëŠ” í…Œì´ë¸”ì„ ì½ì–´ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
>
> ì°¨ì´ì ì€ <br>`Oracle` ì€ ì ‘ì†í•˜ê³ ë‚˜ë©´ ê¶Œí•œì´ í—ˆìš©ëœ ë²”ìœ„ë‚´ì—ì„œ ë‹¨ìˆœ SELECT ë¿ë§Œ ì•„ë‹ˆë¼, `ë‹¤ì–‘í•œ ì‘ì—…ì„ ììœ ë¡­ê²Œ` í•  ìˆ˜ ìˆì§€ë§Œ(**`ì›ê²© í…Œì´ë¸” ìˆ˜ì • ê°€ëŠ¥!`**), <br> `MariaDB` ëŠ” ê°ì ë‹¤ë¥¸ ë°ì´í„°ë² ì´ìŠ¤ ê°„ í…Œì´ë¸” ë™ê¸°í™”ì— ë” ê°€ê¹ìŠµë‹ˆë‹¤. (**`ì›ê²© í…Œì´ë¸” ìˆ˜ì • ë¶ˆê°€!`**)<br>
>
> ì´ë¥¼ í†µí•´ CUDë§Œ ê°€ëŠ¥í–ˆë˜ Kafkaì˜ ë‹¨ì ì„ ë³´ì™„í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤!<br>

<details>
<summary>ë¬´í•œ ê°ì‚¬,,</summary>
<div markdown="1">
MariaDBì—ë„ Synonymê³¼ ë¹„ìŠ·í•œê²Œ ìˆì„ê±°ë¼ê³  íŒíŠ¸ ì£¼ì‹  <b>Skala ì •ìœ¤ì„ êµìˆ˜ë‹˜</b> ê°ì‚¬í•©ë‹ˆë‹¤,,
</div>
</details>

<hr>

### ê²°ê³¼

![Docker-MariaDB](/assets/img/docker-mariadb.png)
![Docker-Ps](/assets/img/docker-ps.png)
![MariaDB-Result](/assets/img/mariadb-result.png)

ì•„ì£¼ ì˜ ìƒì„±ëœ ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

<hr>

## ë§ˆì¹˜ë©°

ì•„ì§ ë§ì´ ë¶€ì¡±í•˜ì§€ë§Œ..ì—´ì‹¬íˆ ë‹¬ë ¤ë³´ê² ìŠµë‹ˆë‹¤...!!<br>
ë‹¤ìŒì€ Federated ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , `GraphQL` ì„ í†µí•´ API Serverì™€ í†µì‹ í•˜ê³ , API Serverê°€ ê° ì„œë²„ë¡œ ìš”ì²­ì„ ì „ë‹¬í•˜ëŠ” í˜•íƒœë¡œ ë™ì‘í•˜ëŠ” API ê¸°ëŠ¥ êµ¬í˜„ì— ëŒ€í•´ ì‘ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤ ğŸ¤¯

<hr>
<br>

> ì°¸ê³  ìë£Œ

[í•˜ë‚˜](https://xshine.tistory.com/327), [ë‘˜](https://jhdatabase.tistory.com/entry/MySQL-MariaDB-Federated-Engine-%EC%82%AC%EC%9A%A9-%ED%85%8C%EC%8A%A4%ED%8A%B8), [ì…‹](https://m.blog.naver.com/ken6ybn/220142473283), [ë„·](https://jangmax.tistory.com/213)
