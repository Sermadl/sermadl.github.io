---
title: "MSA êµ¬í˜„í•˜ê¸°(10) - ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì—ë„ WebFlux ì ìš©í•˜ê¸° (2)"
categories: [Spring Boot, MSA]
tags:
  [
    MSA,
    Spring,
    API Gateway,
    WebFlux,
    JWT,
    Custom Error,
    R2DBC,
    Spring Security,
    Spring Boot,
    Java,
    SKALA,
    SKALA1ê¸°,
    SK
  ]
---

> Skala ê³¼ì •ì—ì„œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ êµ¬ì¡°ì— ëŒ€í•´ ìƒˆë¡­ê²Œ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
> ë°°ìš´ ê²ƒì„ ì‹¤ì œë¡œ êµ¬í˜„í•´ë³´ê¸° ìœ„í•´ ì´ ì—¬ì •ì„ ì‹œì‘í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.<br>[ì²˜ìŒ ê¸€ë¶€í„° ë³´ëŸ¬ê°€ê¸°](<https://sermadl.github.io/posts/MSA(1)/>)

í•´ëƒˆìŠµë‹ˆë‹¤! ì§€í”¼í‹°ì•¼ ê³ ë§ˆì›Œ êµ¬ê¸€ì•„ ê³ ë§ˆì›Œ<br>

ë””ë¹„ë„ ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ R2DBCë¥¼ ì ìš©í•˜ê³ , ì„œë¹„ìŠ¤, ì»¨íŠ¸ë¡¤ëŸ¬ ì½”ë“œë¥¼ ë‹¤ ê³ ì¹˜ê³  ë‚˜ë‹ˆ JWT(ê·¸ë¦¬ê³  Spring Security)ì™€ ì»¤ìŠ¤í…€ ì—ëŸ¬ ì½”ë“œë„ WebFluxìš© ì½”ë“œë¡œ ë¦¬íŒ©í† ë§ í•´ì£¼ì–´ì•¼ í–ˆìŠµë‹ˆë‹¤...<br>

ì²œì²œíˆ ì§„í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤<br>

> ì´ë¯¸ JDBCë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ì—¬ í…Œì´ë¸”ì´ ë§Œë“¤ì–´ì§„ í™˜ê²½ì—ì„œ ë¦¬íŒ©í† ë§ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤<br>
> ì²˜ìŒë¶€í„° R2DBCë¥¼ ì ìš©í•˜ì‹œëŠ” ë¶„ë“¤ì€ sqlë¬¸ì„ ë”°ë¡œ ì‘ì„±í•´ì£¼ì…”ì•¼ tableì´ ìƒì„±ë©ë‹ˆë‹¤.(Flyway ì ìš© ì‹œ ìë™ìœ¼ë¡œ í…Œì´ë¸”ì´ ìƒì„±ë©ë‹ˆë‹¤)<br>

<hr>

## DB ì„¤ì •í•˜ê¸° (MariaDB R2DBC ë“œë¼ì´ë²„ ì‚¬ìš©í•˜ê¸°)

### pom.xml

```xml
.
.
.
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-r2dbc</artifactId>
    <version>3.3.5</version>
</dependency>
<dependency>
    <groupId>org.mariadb</groupId>
    <artifactId>r2dbc-mariadb</artifactId>
    <version>1.2.2</version>
</dependency>
<dependency>
    <groupId>org.mariadb.jdbc</groupId>
    <artifactId>mariadb-java-client</artifactId>
</dependency>
.
.
.
```

r2dbcdìš© ì˜ì¡´ì„±ì„ ì¶”ê°€í•©ë‹ˆë‹¤!<br>

MariaDBë³´ë‹¤ MongoDBë‚˜ PostgreSQLì„ ì“°ëŠ” ê²ƒì´ ìµœì í™”(?)ì— ë” ì¢‹ì„ ê²ƒ ê°™ì§€ë§Œ ì‹¤ì œ ì„œë¹„ìŠ¤ëŠ” ì•„ë‹ˆê³  ê³µë¶€ìš©ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•´ë³´ëŠ” ì„œë²„ë¼<br>
DBëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³  MariaDBì—ì„œ ì§€ì›í•˜ëŠ” r2dbc ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤..!<br>

ì¶”í›„ì— `Flyway` ì ìš©ì„ ìœ„í•´ JDBC ë“œë¼ì´ë²„ë„ ë‚¨ê²¨ì¤ë‹ˆë‹¤.<br>
ê¸°ì¡´ì— JDBCë¡œ ì—°ê²°ì„ í•´ë‘ì…¨ë‹¤ë©´ ì´ ì˜ì¡´ì„± ì½”ë“œëŠ” ì´ë¯¸ ìˆì„ ê²ƒì´ê¸° ë•Œë¬¸ì— ì¶”ê°€í•˜ì§€ ì•Šìœ¼ì…”ë„ ê´œì°®ìŠµë‹ˆë‹¤.<br>

<hr>

### application.yml

```yml
.
.
.
spring:
    sql:
        init:
            mode: always
.
.
.
```

`Flyway` ì ìš©ì„ ìœ„í•œ ì½”ë“œì…ë‹ˆë‹¤. í˜„ì¬ëŠ” ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤.<br>

<hr>

### application.properties

```properties
.
.
.
spring.r2dbc.url=r2dbc:mariadb://localhost:3308/user?allowPublicKeyRetrieval=true&useSSL=false
spring.r2dbc.username={db ìœ ì €}
spring.r2dbc.password={db ë¹„ë°€ë²ˆí˜¸}
```

`?allowPublicKeyRetrieval=true&useSSL=false` ì„¤ì •ì„ í•´ì£¼ì§€ ì•Šìœ¼ë‹ˆê¹Œ DBì— ì—°ê²°ì„ í•  ìˆ˜ ì—†ì–´ì„œ ì¶”ê°€í•´ì¤¬ìŠµë‹ˆë‹¤!<br>
DBì— ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì„ ì„¤ì •í•˜ëŠ” êµ¬ë¬¸ì…ë‹ˆë‹¤.<br>

jdbc ì„¤ì •ì„ ê°™ì´ í•´ì£¼ì…¨ë‹¤ë©´ `spring.datasource.url` ì˜ url ëì—ë„ í•´ë‹¹ êµ¬ë¬¸ì„ ì¶”ê°€í•©ë‹ˆë‹¤.<br>

<hr>

### User.java (Entity)

```java
import org.springframework.data.annotation.Id; // ë§¤ìš° ì¤‘ìš”í•œ
import org.springframework.data.relational.core.mapping.Table; // ë¶€ë¶„ì…ë‹ˆë‹¤..!!

@Table
@Getter
@AllArgsConstructor
@NoArgsConstructor
public class User {
    @Id
    private Long id;
    @Enumerated(EnumType.STRING)
    private UserRole userRole;
    private String username;
    private String password;
    private String email;
    private String phone;

    .
    .
    .
}
```

R2DBCë¥¼ ì‚¬ìš©í•  ê²½ìš° `@Entity` ê°€ ì•„ë‹ˆë¼ `@Table` ì„ ì¨ì•¼í•©ë‹ˆë‹¤.<br>

ì‚¬ìš©ë²•ì€ ê¸°ì¡´ê³¼ ê°™ì´ í…Œì´ë¸”ëª…ê³¼ í´ë˜ìŠ¤ëª…ì´ ë‹¤ë¥´ë‹¤ë©´ `@Table(name="í…Œì´ë¸” ëª…")` ìœ¼ë¡œ ì‘ì„±í•´ì•¼í•˜ë©´ ë©ë‹ˆë‹¤.<br>
[ê³µì‹ ë¬¸ì„œ ë³´ëŸ¬ê°€ê¸°](https://docs.spring.io/spring-data/relational/reference/r2dbc/mapping.html)

### UserRepository.java (Repository)

```java
import org.springframework.data.r2dbc.repository.R2dbcRepository;

public interface UserRepository extends R2dbcRepository<User, Long> {
    Mono<User> findByEmail(String email);
}
```

ë ˆí¬ì§€í† ë¦¬ë„ ê¸°ì¡´ JpaRepsitoryë¥¼ ìƒì†ë°›ë˜ ê²ƒì„ R2dbcRepsitoryë¥¼ ìƒì†ë°›ë„ë¡ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.<br>

repositoryì— ì„ ì–¸í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ ìì²´ëŠ” Jpaì™€ ë‹¤ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>

ì—¬ê¸°ì„œëŠ” ë°”ë¡œ Monoë‚˜ Fluxë¥¼ ë°˜í™˜í•´ì£¼ê¸° ë•Œë¬¸ì— Listë‚˜ Optionalë¡œ ë°˜í™˜ë°›ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì£¼ì„¸ìš”!<br>

<hr>

## ì‹¤ì œ ê¸°ëŠ¥ ìˆ˜í–‰ ì½”ë“œ ìˆ˜ì •í•˜ê¸° (Servcie, Controller ì½”ë“œ ìˆ˜ì •)

### UserService.java (Service)

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class UserService {
    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final KafkaProducer kafkaProducer;

    public Flux<UserInfoResponse> getAll() {
        return userRepository.findAll()
                .map(this::getUserInfo);
    }

    public Mono<UserInfoResponse> getUser(Long userId) {
        return userRepository.findById(userId)
                .switchIfEmpty(Mono.error(new UserNotFoundException()))
                .map(this::getUserInfo);
    }

    public Mono<UserInfoResponse> register(RegisterUserRequest request) {
        User user = new User(
                request.getUsername(),
                passwordEncoder.encode(request.getPassword()),
                request.getEmail(),
                request.getPhone()
        );

        return userRepository.save(user)
                .map(this::getUserInfo);

    }

    public Mono<UserInfoResponse> updateUser(Long userId, UserUpdateRequest request) {
        return transactionalOperator.transactional(
                userRepository.findById(userId)
                        .switchIfEmpty(Mono.error(new UserNotFoundException()))
                        .flatMap(user -> {
                            user.update(
                                    request.getUsername(),
                                    request.getEmail(),
                                    request.getPhone()
                            );

                            return userRepository.save(user);
                        })
                        .map(this::getUserInfo)
        );
    }


    private UserInfoResponse getUserInfo(User user) {
        return new UserInfoResponse(
                user.getId(),
                user.getUsername(),
                user.getEmail(),
                user.getPhone()
        );
    }

}
```

`User` ê°ì²´ë¥¼ `UserInfoResponse` DTO ê°ì²´ë¡œ ë³€í™˜í•´ì£¼ëŠ” `getUserInfo()` í•¨ìˆ˜ë¥¼ ì„ ì–¸í–ˆìŠµë‹ˆë‹¤.<br>

Repositoryë¥¼ í†µí•´ Mono í˜¹ì€ Fluxë¡œ ë°˜í™˜ëœ ê°’ì„ ì¡°íšŒ, ìˆ˜ì •í•˜ëŠ” ì½”ë“œ ê·¸ë¦¬ê³  ì €ì¥í•˜ëŠ” ì½”ë“œê¹Œì§€ ê±°ì˜ ëª¨ë“  ì˜ˆì‹œê°€ ë‹´ê²¨ìˆìŠµë‹ˆë‹¤.<br>

ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ì„ ë•Œ ì •ìƒì ìœ¼ë¡œ ì˜ˆì™¸ì²˜ë¦¬ê°€ ë™ì‘í•˜ë„ë¡ í•˜ê¸° ìœ„í•´ `switchIdEmpty()` ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br>

ìœ ì €ì˜ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” í•¨ìˆ˜ì— `@Transactional` ì–´ë…¸í…Œì´ì…˜ì´ ìˆì—ˆëŠ”ë°,<br>
webfluxì—ì„œ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ ë§Œë“¤ê¸° ìœ„í•´ `transactianlOperator`ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br>

> ë‹¤ìŒ ê¸€ì—ì„œëŠ” ì£¼ë¬¸ ê¸°ëŠ¥ì—ì„œ ë™ì‹œì„± ì œì–´ ë¬¸ì œì— ëŒ€í•´ì„œ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤!

Service ì½”ë“œì—ì„œ Monoì™€ Fluxë¡œ ì´ë¯¸ ë‹¤ ë°˜í™˜ì„ í•´ì¤¬ê¸° ë•Œë¬¸ì— ì´ì „ ê¸€ì—ì„œ ì„¤ì •í•´ë’€ë˜ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì•¼í•©ë‹ˆë‹¤.<br>

<hr>

### UserController.java (Controller)

```java
.
.
.

/** [ê´€ë¦¬ì]
 * ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
 * @param userId ë¡œê·¸ì¸ ëœ ì‚¬ìš©ì Id
 * @param role ë¡œê·¸ì¸ ëœ ì‚¬ìš©ì Role
 * @return ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ë¦¬ìŠ¤íŠ¸
 */
@GetMapping("/list")
public Flux<UserInfoResponse> getAllUsers(
        @RequestHeader("x-user-id") Long userId,
        @RequestHeader("x-user-role") UserRole role
) {
    log.info("user id({}) accessed to find all users", userId);

    RoleCheck.isAdmin(role);

    return userService.getAll();
}

.
.
.
```

ì´ì „ì— `Mono.fromSupplier()` í˜¹ì€ `Flux.defer()` ë“±ìœ¼ë¡œ ë°˜í™˜í•˜ë˜ ì½”ë“œë“¤ì´ ê°„ì†Œí™”ë˜ì—ˆìŠµë‹ˆë‹¤.<br>

<hr>

## Custom Error ì½”ë“œ WebFlux ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •í•˜ê¸°

### CustomException.java

```java
.
.
.
public static CustomException of(Throwable ex) {
    return new UnknownException(ex);
}
.
.
.
```

ê¸°ì¡´ ì½”ë“œì—ì„œ `Exception` ì„ ì¸ìë¡œ ë°›ë˜ `of()` í•¨ìˆ˜ë¥¼ `Throwable` ì„ ë°›ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.<br>

<hr>

### ErrorHandlerFilter.java

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class ErrorHandleFilter implements WebExceptionHandler {

    private final ObjectMapper objectMapper;
    private final MessageSource messageSource;

    @Override
    public Mono<Void> handle(ServerWebExchange exchange, Throwable ex) {
        ServerHttpResponse response = exchange.getResponse();
        response.getHeaders().set(HttpHeaders.CONTENT_TYPE, "application/json;charset=UTF-8");

        Locale locale = exchange.getLocaleContext().getLocale();
        ErrorResponse dto;
        int statusCode;

        if (ex instanceof CustomException customEx) {
            dto = ErrorResponse.of(customEx, messageSource, locale);
            statusCode = customEx.getStatus().value();
            log.error("A problem has occurred in filter: [id={}]", dto.getTrackingId(), customEx);
        } else {
            dto = ErrorResponse.of(CustomException.of(ex), messageSource, locale);
            statusCode = HttpStatus.INTERNAL_SERVER_ERROR.value();
            log.error("Unexpected exception has occurred in filter: [id={}]", dto.getTrackingId(), ex);
        }

        response.setStatusCode(HttpStatus.valueOf(statusCode));

        try {
            byte[] bytes = objectMapper.writeValueAsBytes(dto);
            DataBuffer buffer = response.bufferFactory().wrap(bytes);
            return response.writeWith(Mono.just(buffer));
        } catch (Exception e) {
            log.error("Error writing error response", e);
            return response.setComplete(); // fallback
        }
    }
}
```

ì´ í´ë˜ìŠ¤ëŠ” ê±°ì˜ ëª¨ë“  ì½”ë“œê°€ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤,,<br>
ê¸°ì¡´ MVC ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ë˜ ì½”ë“œê°€ WebFlux ë°©ì‹ìœ¼ë¡œ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•  ìˆ˜ ìˆë„ë¡ ë°”ê¿”ì¤¬ìŠµë‹ˆë‹¤.<br>
[ë ˆí¼ëŸ°ìŠ¤](https://velog.io/@joon6093/%EA%B3%B5%EB%B6%80%EC%A0%95%EB%A6%AC-SpringCloudGateway%EC%97%90%EC%84%9CWebExceptionHandler%EB%A1%9C-%EC%A0%84%EC%97%AD-%EC%97%90%EB%9F%AC-%EC%B2%98%EB%A6%AC)

<hr>

## Jwt ì½”ë“œ WebFlux ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •í•˜ê¸°

### JwtAuthenticationFilter.java

```java
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter implements WebFilter {

    private final JwtProvider jwtProvider;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();

        String token = jwtProvider.getAccessTokenFromHeader(request);
        if (token != null) {
            Authentication authentication = jwtProvider.getAuthentication(token);

            return chain.filter(exchange)
                    .contextWrite(ReactiveSecurityContextHolder.withAuthentication(authentication));
        }

        return chain.filter(exchange);
    }
}
```

`OncePerRequestFilter` ëŒ€ì‹  `WebFilter` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ë„ë¡ í•˜ê³ ,<br>
WebFlux ë°©ì‹ëŒ€ë¡œ ë™ì‘í•˜ë„ë¡ ì‘ì„±í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>

<hr>

### JwtAuthEntryPoint.java

```java
@Component
public class JwtAuthEntryPoint implements ServerAuthenticationEntryPoint {

    @Override
    public Mono<Void> commence(ServerWebExchange exchange, AuthenticationException ex) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(HttpStatus.UNAUTHORIZED);
        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);

        String body = "{\"message\": \"" + ex.getMessage() + "\"}";

        DataBuffer buffer = response.bufferFactory().wrap(body.getBytes(StandardCharsets.UTF_8));
        return response.writeWith(Mono.just(buffer));
    }
}
```

`AuthenticationEntryPoint` ëŒ€ì‹  `ServerAuthenticationEntryPoint` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³  WebFlux ë°©ì‹ìœ¼ë¡œ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>
[ë ˆí¼ëŸ°ìŠ¤](https://dzone.com/articles/authentication-with-remote-ldap-server-in-spring-webflux)

<hr>

### JwtProvider.java

```java
.
.
.
public String getAccessTokenFromHeader(ServerHttpRequest request) {
    // 1. ì¿ í‚¤ì—ì„œ access-token í™•ì¸
    MultiValueMap<String, HttpCookie> cookies = request.getCookies();
    HttpCookie cookie = cookies.getFirst("access-token");
    if (cookie != null) {
        return cookie.getValue();
    }

    // 2. Authorization í—¤ë”ì—ì„œ Bearer í† í° ì¶”ì¶œ
    String header = request.getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
    if (header != null) {
        if (!header.toLowerCase().startsWith(BEARER)) {
            log.info("Invalid header format: {}", header);
            throw new RuntimeException("Invalid Authorization header");
        }
        return header.substring(7); // "Bearer " ì œê±°
    }

    log.info("Authorization header is missing!");
    return null;
}
.
.
.
```

`HttpServletRequest` ëŒ€ì‹  `ServerHttpRequest` ë¥¼ ì¸ìë¡œ ë°›ë„ë¡ í•˜ê³ ,<br>
ì¿ í‚¤ ê´€ë ¨ ì½”ë“œ ë° ì—ëŸ¬ ì½”ë“œê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤. (ì¶”í›„ ì»¤ìŠ¤í…€ ì—ëŸ¬ë¡œ ë°”ê¿€ ì˜ˆì •ì…ë‹ˆë‹¤,,~~ê¹Œë¨¹ì—ˆì–´ìš”~~)<br>

<hr>

### SecurityConfig.java (Jwtë¥¼ ì ìš©í•  Spring Security ì„¤ì • ìˆ˜ì •)

```java
@Configuration
@EnableWebFluxSecurity
@EnableMethodSecurity(securedEnabled = true)
@RequiredArgsConstructor
public class SecurityConfig {
    private final ObjectMapper objectMapper;
    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    public MessageSource messageSource() {
        ReloadableResourceBundleMessageSource messageSource = new ReloadableResourceBundleMessageSource();
        messageSource.setBasename("messages");
        messageSource.setDefaultEncoding("UTF-8");
        messageSource.setCacheSeconds(60);
        messageSource.setDefaultLocale(Locale.KOREA);
        messageSource.setUseCodeAsDefaultMessage(true);
        return messageSource;
    }

    @Bean(name = "messageSourceAccessor")
    public MessageSourceAccessor messageSourceAccessor(MessageSource messageSource) {
        return new MessageSourceAccessor(messageSource, Locale.getDefault());
    }

    @Bean
    public JwtAuthEntryPoint jwtAuthEntryPoint() {
        return new JwtAuthEntryPoint();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public ErrorHandleFilter errorHandleFilter() {
        return new ErrorHandleFilter(objectMapper, messageSource());
    }

    @Bean
    public CorsWebFilter corsWebFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true);
        config.addAllowedOrigin("*");
        config.addAllowedHeader("*");
        config.addAllowedMethod("*");

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);

        return new CorsWebFilter(source);
    }

    @Bean
    public SecurityWebFilterChain filterChain(ServerHttpSecurity http) throws Exception {
        return http
                .cors(httpSecurityCorsConfigurer -> corsWebFilter())
                .csrf(ServerHttpSecurity.CsrfSpec::disable)
                .formLogin(ServerHttpSecurity.FormLoginSpec::disable)
                .httpBasic(ServerHttpSecurity.HttpBasicSpec::disable)
                .authorizeExchange(exchange -> exchange
                        .pathMatchers("/**").permitAll()
                        .anyExchange().authenticated()
                )
                .addFilterAt(jwtAuthenticationFilter, SecurityWebFiltersOrder.AUTHENTICATION)
                .build();
    }
}
```

ì´ ì½”ë“œë„ ê±°ì˜ ì „ë°˜ì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆëŠ”ë°<br>

`@EnableWebSecurity` ëŒ€ì‹  `@EnableWebFluxSecurity` ë¥¼ í†µí•´ WebFlux ê¸°ë°˜ Security ì„¤ì •ì„ í•  ê²ƒì„ ì•Œë¦½ë‹ˆë‹¤.<br>

webflux ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” Spring SecurityëŠ” ìƒê°ë³´ë‹¤ ìë™ìœ¼ë¡œ ì°¾ì•„ì£¼ëŠ” ê¸°ëŠ¥ì´ ë§ì•„ì„œ ì˜¤íˆë ¤ ì‚­ì œí•œ ë¹ˆì´ ìˆìŠµë‹ˆë‹¤. (ë‹¤ì¤‘ ì–¸ì–´ ì ìš© ê´€ë ¨ ë¹ˆì€ ê±°ì˜ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤)<br>

`Cors ì—ëŸ¬` ê´€ë ¨í•œ í•¨ìˆ˜ë„ ì‚¬ìš©í•˜ëŠ” ê°ì²´ê°€ ë‹¬ë¼<br>
`CorsConfigurationSource` ì—ì„œ `CorsWebFilter` ë¥¼ ë°˜í™˜í•˜ë„ë¡ ë°”ê¾¸ì—ˆìŠµë‹ˆë‹¤.<br>
í•´ë‹¹ ì„¤ì • ì‹œ `UrlBasedCorsConfigurationSource` ì˜ import ê²½ë¡œì— `reactive` ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ìœ ì˜í•´ì£¼ì„¸ìš”..!<br>

ê°€ì¥ ì¤‘ìš”í•œ `filterChain` í•¨ìˆ˜ê°€ `SecurityWebFilterChain` ì„ ë°˜í™˜í•˜ê³  `ServerHttpSecurity` ë¥¼ ì¸ìë¡œ ë°›ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.<br>
ê¸°ì¡´ì—ëŠ” ë¹ˆìœ¼ë¡œ ë“±ë¡í–ˆë˜ `JwtAuthenticationFilter` ë¥¼ ì—¬ê¸°ì„œ ë“±ë¡í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë°”ê¿”ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>

ë‚˜ë¨¸ì§€ ë‹¤ë¥¸ ê¸°ëŠ¥ë“¤ë„ WebFlux ë°©ì‹ì— ë§ê²Œ `ServerHttpSecurity` ë¥¼ í†µí•´ ì„¤ì •í•´ì£¼ë©´<br>
Security êµ¬ì„±ë„ ëì…ë‹ˆë‹¤!<br>

<hr>

## ë§ˆì¹˜ë©°

ìƒê°ë³´ë‹¤ ì‰¬ì› ê³ , ìƒê°ë³´ë‹¤ ë³µì¡í–ˆë˜ WebFlux ì ìš©ê¸°ì˜€ìŠµë‹ˆë‹¤,,<br>
ì±—ì§€í”¼í‹°ì™€ í•¨ê»˜ë¼ë©´,,ìƒˆë¡œìš´ ê¸°ìˆ ,,,ì–´ë µì§€ ì•Šì„ì§€ë„,,,,,,<br>

ì´ê²Œ ì™œ ë˜ì§€? ë¼ëŠ” ìƒê°ì´ ë“¤ì§€ ì•Šë„ë¡ ë” ì—´ì‹¬íˆ ê³µë¶€í•´ì•¼ê² ìŠµë‹ˆë‹¤..!<br>

ë‹¤ìŒì—ëŠ” ë™ì‹œì„±ì— ëŒ€í•´ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤<br>

ğŸœğŸ’¦

<hr>
<br>

> ì°¸ê³  ìë£Œ

[í•˜ë‚˜](https://docs.spring.io/spring-data/relational/reference/r2dbc.html), [ë‘˜](https://docs.spring.io/spring-framework/reference/web/webflux.html), [ì…‹](https://velog.io/@joon6093/%EA%B3%B5%EB%B6%80%EC%A0%95%EB%A6%AC-SpringCloudGateway%EC%97%90%EC%84%9CWebExceptionHandler%EB%A1%9C-%EC%A0%84%EC%97%AD-%EC%97%90%EB%9F%AC-%EC%B2%98%EB%A6%AC), [ë„·](https://tzara.tistory.com/169), [ë‹¤ì„¯](https://mariadb.com/kb/en/install-mariadb-connector-r2dbc-spring-data/), [ì—¬ì„¯](https://medium.com/@fajrimoad/how-to-migrate-your-spring-repositories-to-reactive-r2dbc-repositories-mysql-db-fb961445de6c), [ì¼ê³±](https://velog.io/@armton/WebFlux-%EA%B8%B0%EB%B0%98%EC%97%90%EC%84%A0-jpa%EB%8A%94-%EA%B6%8C%EC%9E%A5%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94%EB%8C%80)
