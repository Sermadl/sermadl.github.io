---
title: "MSA êµ¬í˜„í•˜ê¸°(11) - ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì—ë„ WebFlux ì ìš©í•˜ê¸° (3) (feat. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)"
categories: [Spring Boot, MSA]
tags:
  [
    MSA,
    Spring,
    API Gateway,
    WebFlux,
    R2DBC,
    Spring Security,
    Spring Boot,
    Java,
    SKALA,
    SKALA1ê¸°,
    SK
  ]
---

> Skala ê³¼ì •ì—ì„œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ êµ¬ì¡°ì— ëŒ€í•´ ìƒˆë¡­ê²Œ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
> ë°°ìš´ ê²ƒì„ ì‹¤ì œë¡œ êµ¬í˜„í•´ë³´ê¸° ìœ„í•´ ì´ ì—¬ì •ì„ ì‹œì‘í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.<br>[ì²˜ìŒ ê¸€ë¶€í„° ë³´ëŸ¬ê°€ê¸°](<https://sermadl.github.io/posts/MSA(1)/>)

R2DBCê°€ ìƒê°ë³´ë‹¤ ë¶ˆì¹œì ˆí•œ ë“œë¼ì´ë²„ì˜€ìŠµë‹ˆë‹¤,,<br>

JDBCê°€ ì§€ì›í•´ì£¼ë˜ ê²ƒì„ ì§€ì›í•´ì£¼ì§€ ì•ŠëŠ” ê²½ìš°ê°€ êµ‰ì¥íˆ ë§ì•„ì„œ<br>
ë¨¸ë¦¬ê°€ ë‹¤ ë½‘í ë»” í–ˆì§€ë§Œ í•´ê²°í–ˆìŠµë‹ˆë‹¤ ğŸ˜‹<br>

<hr>

## SecurityConfig.java

ìš°ì„  User ì„œë²„ì—ì„œëŠ” JWTë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆê¸°ì— `POST` ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í–ˆì—ˆëŠ”ë°<br>
ê°™ì€ ì½”ë“œë¥¼ Order ì„œë²„ì— ì‚¬ìš©í•˜ë‹ˆ `An expected CSRF token cannot be found` ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>

ì‚¬ì‹¤ User ì„œë²„ì—ì„œë„ ì˜ëª»ëœ ì½”ë“œë¥¼ ì‘ì„±í–ˆë˜ ê²ƒì´ì—ˆëŠ”ë° JWTê°€ CSRF ê³µê²© ë°©ì–´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ë˜ ê²ƒì´ê³ <br>
ì§€ê¸ˆ ì„œë²„ì—ì„œëŠ” JWT í† í°ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤,,<br>

```java
.
.
.
return http
        .csrf(ServerHttpSecurity.CsrfSpec::disable)
        .
        .
        .
        .build();
```

WebFluxì—ì„œëŠ” ì´ë ‡ê²Œ ì„¤ì •í•´ì£¼ì–´ì•¼ ì •ìƒì ìœ¼ë¡œ CSRF ë°©ì–´ ê¸°ëŠ¥ì„ í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!<br>

<hr>

## R2DBCì—ì„œ Primary Key ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•˜ê¸°

ê¸°ì¡´ì— ì£¼ë¬¸ ë²ˆí˜¸ë¥¼ Primary Keyë¡œ ì‚¬ìš©í•˜ê³  ìˆì—ˆê¸° ë•Œë¬¸ì—<br>
DBì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ëŠ” ID ëŒ€ì‹  ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ìƒì„±í•˜ëŠ” ë¡œì§ì„ ë”°ë¡œ ë‘ì–´ì„œ IDë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•´ë‘ê³  ìˆì—ˆëŠ”ë°<br>

R2DBCì—ì„œëŠ” ID ê°’ì´ ìˆëŠ” ìƒíƒœë¡œ `repository.save()` ë©”ì†Œë“œê°€ ì‹¤í–‰ë˜ë©´ `insert` ê°€ ì•„ë‹Œ, `update` ë¡œ ì‹¤í–‰ëœë‹¤ëŠ” ê²ƒì„..<br>
ë„ˆë¬´ ëŠ¦ê²Œ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤..<br>

ì²˜ìŒì—ëŠ” ë¹„ë™ê¸°ì‹ìœ¼ë¡œ DBì— ì£¼ë¬¸ì„ ì €ì¥í•˜ê¸° ë•Œë¬¸ì— Ordersê°€ ì €ì¥ë˜ê¸° ì´ì „ì— OrderItemì´ ë¨¼ì € ì €ì¥ë˜ì–´ orders.getId()ê°€ ì œëŒ€ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ì¤„ ì•Œì•˜ëŠ”ë°(ì•„ì˜ˆ í‹€ë¦° ê°€ì„¤ì€ ì•„ë‹ˆì—ˆìŠµë‹ˆë‹¤,,)<br>

ê·¸ê²ƒë³´ë‹¤ IDë¥¼ ì„¤ì •í•´ì¤¬ê¸° ë•Œë¬¸ì— `update` ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ”ë° ë‹¹ì—°íˆ ìƒˆë¡œ ìƒì„±í•œ IDì— ë§ëŠ” rowê°€ ì—†ì—ˆê¸°ì—..í•­ëª©ì„ ì°¾ì§€ ëª»í–ˆë‹¤ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•œ ê²ƒì´ì—ˆìŠµë‹ˆë‹¤..<br>

<hr>

### Orders.java

```java
@Table
@Getter
@AllArgsConstructor
@NoArgsConstructor
public class Orders implements Persistable<String> {

    @Id
    private String id;
    private Long customerId;
    private BigDecimal totalPrice;
    private String address;
    private String description;

    @Transient
    private boolean isNew;

    public Orders(Long customerId, BigDecimal totalPrice, String address, String description) {
        this.id = generateOrderNumber();
        this.customerId = customerId;
        this.totalPrice = totalPrice;
        this.address = address;
        this.description = description;
        this.isNew = true;
    }

    .
    .
    .

    @Override
    public boolean isNew() {
        return isNew;
    }
}
```

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” 2ê°€ì§€ ë°©ë²•ì´ ìˆëŠ”ë°<br>

Repository í´ë˜ìŠ¤ì—ì„œ ì§ì ‘ `@Query` ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ insert ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ëŠ” ë°©ë²•ê³¼,<br>
ì œê°€ ì‚¬ìš©í•œ `Persistable` ì„ ìƒì†ë°›ì•„ í•´ë‹¹ rowê°€ ìƒˆë¡œ ìƒì„±ëœ rowì¸ì§€ë¥¼ ì•Œë ¤ì£¼ëŠ” `isNew()` ë¥¼ ì˜¤ë²„ë¼ì´ë”© í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.<br>

`Persistable<String>` ì—ì„œ Stringì„ ì‘ì„±í•´ì¤€ ì´ìœ ëŠ” ë‹¨ìˆœí•˜ê²Œ ì œ IDê°€ Stringìœ¼ë¡œ ì„ ì–¸ë˜ì–´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤<br>
ìƒí™©ì— ë”°ë¼ì„œ ì ì ˆí•˜ê²Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”!<br>

OrderItemë„ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ë°”ê¿”ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>

<hr>

## ì¼ë¶€ ë¡œì§ì„ ë™ê¸°ì‹ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ ë³€ê²½

ì£¼ë¬¸ì„ ì €ì¥í•˜ëŠ” Requestì˜ êµ¬ì¡°ê°€<br>

```java
public class PurchaseRequest {
    private String address;
    private String description;
    private List<PurchaseItemRequest> itemList;
    private BigDecimal totalPrice;
}
```

ì´ë ‡ê²Œ ë˜ì–´ ìˆê³ ,<br>

ì£¼ë¬¸ë‚´ì—­ì„ ì €ì¥í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ë¡œì§ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.<br>

1. ì£¼ë¬¸ ì •ë³´(Orders)ë¥¼ ë¨¼ì € DBì— ì €ì¥í•˜ê³ 
2. ì €ì¥ëœ ì£¼ë¬¸ì˜ Idë¥¼ ê° ì„¸ë¶€ ì£¼ë¬¸ í•­ëª©(OrderItem)ì— í¬í•¨ì‹œì¼œ DBì— ì €ì¥í•©ë‹ˆë‹¤.
3. DTOë¡œ ì£¼ë¶„ ì •ë³´ì™€ ì„¸ë¶€ ì£¼ë¬¸ í•­ëª©ì„ ì£¼ë¬¸ ë‚´ì—­ìœ¼ë¡œ ì •ë¦¬í•´ì„œ ë°˜í™˜í•©ë‹ˆë‹¤.

ì´ë•Œ, ëª¨ë“  ë¡œì§ì´ ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ìˆ˜í–‰í–ˆë”ë‹ˆ OrderItemì´ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤<br>

<hr>

### OrderServices.java

```java
.
.
.

public Mono<OrderResponse> register(PurchaseRequest request, Long userId) {
    List<PurchaseItemRequest> itemRequests = request.getItemList();

    Orders orders = new Orders(
            userId,
            request.getTotalPrice(),
            request.getAddress(),
            request.getDescription()
    );

    return orderRepository.save(orders)
            .flatMap(order ->
                registerItem(itemRequests, order)
                        .then(getOrderResponse(order))
            );
}

private Mono<Void> registerItem(List<PurchaseItemRequest> requests,
                            Orders order) {
    return Flux.fromIterable(requests)
            .flatMap(request -> {
                OrderItem orderItem = new OrderItem(
                        order.getId(),
                        request.getItemId(),
                        request.getSellerId(),
                        request.getName(),
                        request.getQuantity(),
                        request.getPrice()
                );

                return orderItemRepository.save(orderItem)
                        .doOnSuccess(kafkaProducer::sendDbUpdateMessage);
            })
            .then();

}

private Mono<OrderResponse> getOrderResponse(Orders order) {
    return orderItemRepository.findByOrderId(order.getId())
            .map(this::getOrderItemResponse)
            .collectList()
            .map(orderItems ->
                new OrderResponse(
                        order.getId(),
                        order.getCreatedAt(),
                        orderItems,
                        order.getAddress(),
                        order.getDescription(),
                        order.getTotalPrice()
                )
            );
}

.
.
.
```

DBì— ì €ì¥ë˜ëŠ” ë¶€ë¶„ë§Œ ì¼ë¶€ ë™ê¸°ì‹(ì²´ì¸)ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ ì„¤ì •í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.<br>

1. Ordersê°€ ì •ìƒì ìœ¼ë¡œ DBì— ì €ì¥ëœë‹¤ë©´
2. `registerItem()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤
3. `registerItem()` í•¨ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆë‹¤ë©´ `getOrderResponse()` í•¨ìˆ˜ë¥¼ í†µí•´ DTOë¡œ ì£¼ë¬¸ ë‚´ì—­ì„ ë°˜í™˜í•©ë‹ˆë‹¤.<br>

ê·¸ ê²°ê³¼ ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ DBì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!<br>

<hr>

ì •ë§ ë³„ê±° ì•„ë‹Œ ê²ƒ ê°™ì§€ë§Œ...ë„ëŒ€ì²´ ì–´ë””ê°€ ë¬¸ì œì¸ì§€ ì°¾ëŠ” ê²ƒì´ ì—„ì²­ë‚˜ê²Œ í˜ë“¤ì—ˆìŠµë‹ˆë‹¤.<br>

ë¶„ëª… ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ë™ì‘í•˜ë˜ ë¡œì§ ë•Œë¬¸ì— Ordersê°€ ì œëŒ€ë¡œ ì €ì¥ë˜ì§€ ì•Šì•„ì„œ ë°œìƒí•œ ì˜¤ë¥˜ì¸ ì¤„ ì•Œì•˜ëŠ”ë°<br>

```java
orderRepository.save(orders)
    .doOnNext(order -> log.info("Order saved! Id: {}", order.getId()))
    .flatMap(order ->
        registerItem(itemRequests, order)
                .then(getOrderResponse(order))
    );
```

ì´ ë¡œê·¸ë¥¼ ì°ì–´ë³´ê³ ...ë‚˜ì„œì•¼....ê·¸ê²Œ ë¬¸ì œê°€ ì•„ë‹ˆë¼ëŠ” ê²ƒì„......DBì— ì €ì¥ì¡°ì°¨ ë˜ê³  ìˆì§€ ì•Šë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.....<br>

ğŸ¥¹

<hr>

## ë§ˆì¹˜ë©°

WebFluxë„, R2DBCë„ ì²˜ìŒ ë‹¤ë¤„ë³´ë‹¤ë³´ë‹ˆ ì˜¤ë¥˜ë¥¼ ë§ë‹¥ëœ¨ë ¸ì„ ë•Œ ì–´ë””ì„œë¶€í„° ì–´ë–»ê²Œ ë¬´ì—‡ì´ ì˜ëª»ë˜ì—ˆëŠ”ì§€ë¥¼ ê°€ëŠ í•˜ê¸°ê°€ ì¡°ê¸ˆ ì–´ë ¤ì› ë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤..<br>

ê·¸ë˜ë„ ì´ì œ 10%ëŠ” ì´í•´í•˜ê²Œ ëœ ê²ƒ ê°™ì•„ì„œ ë¿Œë“¯í•©ë‹ˆë‹¤!<br>

ğŸ˜µâ€ğŸ’«ğŸ£

<hr>
<br>

> ì°¸ê³  ìë£Œ

[í•˜ë‚˜](https://github.com/spring-projects/spring-data-examples/tree/main/r2dbc/example), [ë‘˜](https://binux.tistory.com/155), [ì…‹](https://kim-daeyong.github.io/2022-06-24-r2dbccustomid/), [ë„·](https://hiphopddori.tistory.com/127), [ë‹¤ì„¯](https://yongkyu-jang.medium.com/r2dbc%EC%9D%98-%ED%95%9C%EA%B3%84%EC%99%80-%EA%B7%B8-%EC%82%AC%EC%9A%A9%EB%B2%95-91cfb869cada), [ì—¬ì„¯](https://jaehoney.tistory.com/412)
